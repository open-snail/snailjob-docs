---
title: 架构与功能
date: 2023-07-07 23:01:47
permalink: /pages/540554/
---


# 系统架构及概念
<img :src="$withBase('/img/系统架构图- 2.0.png')" class="no-zoom" style="zoom: 100%;">


# 客户端

# 服务端

<img :src="$withBase('/img/系统功能架构图-v2.0.png')" class="no-zoom" style="zoom: 100%;">

## 🔴任务调度
>Akka 是一个用于构建高并发、分布式和弹性系统的开源工具包和运行时环境。它是基于 Actor 模型的框架，提供了一种并发编程模型，可以轻松地处理并发任务和消息传递
> 任务调度整体是基于AKKA实现全异步化流程

下面是整个任务调度的数据和核心节点的流转图
<img :src="$withBase('/img/任务调度数据流转图.png')" class="no-zoom" style="zoom: 100%;">


### 🟢任务扫描器(ScanGroupActor，ScanCallbackGroupActor)
每个组都对应一个`ScanGroupActor`扫描器， 定时任务每10秒触发一次扫描任务，通过`ScanGroupActor`将所有任务扫描出来，通过`FilterStrategy`
进行数据过滤，为防止任务重复执行使用`BitSet`进行幂等标记， 符合执行条件的任务通过AKKA的发布订阅模型发送消息。

### 🟢任务执行器(ExecUnitActor、ExecCallbackUnitActor)
- 任务执行器监听扫描器发送的消息，通过`RpcClient`向客户端回放重试流量或者执行回调；
- 通过控制台配置的退避策略执行`waitStrategy`计算下次执行时间, 若符合`stopStrategy`则执行具体的停止策略
- 同时需要记录任务的执行情况(成功或者失败)，删除幂等标记。

### 🟢任务策略
> 任务策略采用责任链模式，按照`order`从小到大依次执行策略

1. (过滤器策略)FilterStrategies
   - TriggerAtFilterStrategies: 触发时间过滤策略
   - BitSetIdempotentFilterStrategies: BitSet幂等过滤策略
   - SceneBlackFilterStrategies: 场景黑名单策略
   - CheckAliveClientPodFilterStrategies: 存活的客户端过滤策略
   - RateLimiterFilterStrategies: 客户端限流过滤策略
   - ReBalanceFilterStrategies: 正在rebalance时不允许下发重试流量过滤策略
2. (停止策略)StopStrategies
   - ResultStatusStopStrategy: 调用客户端发生异常触发停止策略
   - ResultStatusCodeStopStrategy: 根据客户端返回状态判断是否终止重试
   - ExceptionStopStrategy: 根据客户端返回结果对象的状态码判断是否终止重试
3. (等待策略)WaitStrategies
  - DelayLevelWaitStrategy: 延迟等级等待策略
  - FixedWaitStrategy: 固定定时间等待策略
  - CronWaitStrategy: cron等待策略
  - RandomWaitStrategy: 随机等待策略

### 🟢执行结果处理器
任务调度成功(FinishActor)
`FinishActor`监听任务完成消息，
- 若是重试任务完成需要创建一个回调任务，更新任务状态为已完成
- 若是回调任务直接更新任务为已完成

任务调度失败(FailureActor)
`FailureActor`监听任务执行失败消息
- 若是重试任务到达最大重试次数，则更新任务状态为最大次数并创建一个回调任务
- 若是回调任务到达最大重试次数，则更新任务状态为最大次数

## 🔴其他模块
### 🟢组负载均衡器
组负载均衡器通过一致性HASH算法将组均匀的分配到每个服务端节点上
以下是触发组负载均衡器ReBalance的条件
- 若本地缓存节点为空则触发ReBalance
- 若远程的节点与本地缓存节点数量不一致则触发ReBalance
- 若远程的节点与本地缓存节点hostId不匹配则触发ReBalance
- 若组远程的组数量与本地缓存的组数量不一致则触发触发ReBalance

### 🟢配置中心
- 配置管理
  通过控制台进行组、场景、通知配置
- 配置通知
  - 服务端主动感知版本变更: 控制台变更配置时版本号会自增，此次会通知客户端配置变更
  - 客户端携带版本号: 客户端每次请求服务端都会携带版本号与服务端校验版本是否一致
  当版本发生变化时，以轮询方式通知客户端变更配置

### 🟢注册中心
#### 🟡注册
  - 客户端使用Netty的心跳(30s一次)与服务端保持连接，每次心跳都会将任务放到本地队列中有定时任务获取队列信息更新过期时间
  - 服务端使用定时(30s一次)任务定时更新过期时间
#### 🟡过期下线
  - 删除到达过期时间的节点
### 🟢全局id生成器
号段模式: 号段模式使用自美团的leaf号段模式
雪花算法: 使用hutool自带的雪花算法生成id，若出现时间回拨问题则直接报错
### 🟢日志模块
日志分为`retry_task_log`和`retry_task_log_message`表
- `retry_task_log`表主要是存放任务的主要信息包括 unique_id、group_name、scene_name、idempotent_id、retry_status等
- `retry_task_log_message`表存放每次调度产生的结果信息
### 🟢告警通知
> 目前已支持钉钉通知、邮箱通知、飞书通知
- 通知场景:
    - 重试数量超过阈值: 作用于服务端，重试中的数量到达阈值发送通知
    - 重试失败数量超过阈值: 作用于服务端，达到最大重试次数的数量到达阈值发送通知
    - 客户端上报失败: 作用于客户端，上报数据失败 发送 通知
## 🔴通信模块
### 🟡RpcClint
> RpcClint是通过动态代理实现的可以基于配置的路由策略选取可执行的客户端IP+PORT, 并支持路由剔除和路由转移功能

- 客户端路由策略算法
  - 一致性Hash算法
  - LRU算法
  - 随机算法

- 路由剔除:
  当调用客户端时出现网络异常时，自动剔除当前活跃列表中的路由信息(IP+PORT)
- 路由转移:
  重新在活跃列表中选取一个路由信息，调用客户端

### 🟡NettyServer
> 处理客户端请求

- BeatHttpRequestHandler(/beat)
  接收心跳请求，存储到本地队列
- ConfigHttpRequestHandler(/config)
  获取最新的配置信息
- ReportRetryInfoHttpRequestHandler(/batch/report)
  接受并处理上报的信息
