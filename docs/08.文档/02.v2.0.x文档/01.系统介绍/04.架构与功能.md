---
title: æ¶æ„ä¸åŠŸèƒ½
date: 2023-07-07 23:01:47
permalink: /pages/540554/
---


# ç³»ç»Ÿæ¶æ„åŠæ¦‚å¿µ
<img :src="$withBase('/img/ç³»ç»Ÿæ¶æ„å›¾- 2.0.png')" class="no-zoom" style="zoom: 100%;">


# å®¢æˆ·ç«¯

# æœåŠ¡ç«¯

<img :src="$withBase('/img/ç³»ç»ŸåŠŸèƒ½æ¶æ„å›¾-v2.0.png')" class="no-zoom" style="zoom: 100%;">

## ğŸ”´ä»»åŠ¡è°ƒåº¦
>Akka æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºé«˜å¹¶å‘ã€åˆ†å¸ƒå¼å’Œå¼¹æ€§ç³»ç»Ÿçš„å¼€æºå·¥å…·åŒ…å’Œè¿è¡Œæ—¶ç¯å¢ƒã€‚å®ƒæ˜¯åŸºäº Actor æ¨¡å‹çš„æ¡†æ¶ï¼Œæä¾›äº†ä¸€ç§å¹¶å‘ç¼–ç¨‹æ¨¡å‹ï¼Œå¯ä»¥è½»æ¾åœ°å¤„ç†å¹¶å‘ä»»åŠ¡å’Œæ¶ˆæ¯ä¼ é€’
> ä»»åŠ¡è°ƒåº¦æ•´ä½“æ˜¯åŸºäºAKKAå®ç°å…¨å¼‚æ­¥åŒ–æµç¨‹

### ğŸŸ¢ä»»åŠ¡æ‰«æå™¨(ScanGroupActorï¼ŒScanCallbackGroupActor)
æ¯ä¸ªç»„éƒ½å¯¹åº”ä¸€ä¸ª`ScanGroupActor`æ‰«æå™¨ï¼Œ å®šæ—¶ä»»åŠ¡æ¯10ç§’è§¦å‘ä¸€æ¬¡æ‰«æä»»åŠ¡ï¼Œé€šè¿‡`ScanGroupActor`å°†æ‰€æœ‰ä»»åŠ¡æ‰«æå‡ºæ¥ï¼Œé€šè¿‡`FilterStrategy`
è¿›è¡Œæ•°æ®è¿‡æ»¤ï¼Œä¸ºé˜²æ­¢ä»»åŠ¡é‡å¤æ‰§è¡Œä½¿ç”¨`BitSet`è¿›è¡Œå¹‚ç­‰æ ‡è®°ï¼Œ ç¬¦åˆæ‰§è¡Œæ¡ä»¶çš„ä»»åŠ¡é€šè¿‡AKKAçš„å‘å¸ƒè®¢é˜…æ¨¡å‹å‘é€æ¶ˆæ¯ã€‚

### ğŸŸ¢ä»»åŠ¡æ‰§è¡Œå™¨(ExecUnitActorã€ExecCallbackUnitActor)
- ä»»åŠ¡æ‰§è¡Œå™¨ç›‘å¬æ‰«æå™¨å‘é€çš„æ¶ˆæ¯ï¼Œé€šè¿‡`RpcClient`å‘å®¢æˆ·ç«¯å›æ”¾é‡è¯•æµé‡æˆ–è€…æ‰§è¡Œå›è°ƒï¼›
- é€šè¿‡æ§åˆ¶å°é…ç½®çš„é€€é¿ç­–ç•¥æ‰§è¡Œ`waitStrategy`è®¡ç®—ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´, è‹¥ç¬¦åˆ`stopStrategy`åˆ™æ‰§è¡Œå…·ä½“çš„åœæ­¢ç­–ç•¥
- åŒæ—¶éœ€è¦è®°å½•ä»»åŠ¡çš„æ‰§è¡Œæƒ…å†µ(æˆåŠŸæˆ–è€…å¤±è´¥)ï¼Œåˆ é™¤å¹‚ç­‰æ ‡è®°ã€‚

### ğŸŸ¢ä»»åŠ¡ç­–ç•¥
> ä»»åŠ¡ç­–ç•¥ä½¿ç”¨è´£ä»»é“¾æ¨¡å¼ï¼ŒæŒ‰ç…§`order`ä»å°åˆ°å¤§ä¾æ¬¡æ‰§è¡Œç­–ç•¥

1. (è¿‡æ»¤å™¨ç­–ç•¥)FilterStrategies
   - TriggerAtFilterStrategies: è§¦å‘æ—¶é—´è¿‡æ»¤ç­–ç•¥
   - BitSetIdempotentFilterStrategies: BitSetå¹‚ç­‰è¿‡æ»¤ç­–ç•¥
   - SceneBlackFilterStrategies: åœºæ™¯é»‘åå•ç­–ç•¥
   - CheckAliveClientPodFilterStrategies: å­˜æ´»çš„å®¢æˆ·ç«¯è¿‡æ»¤ç­–ç•¥
   - RateLimiterFilterStrategies: å®¢æˆ·ç«¯é™æµè¿‡æ»¤ç­–ç•¥
   - ReBalanceFilterStrategies: æ­£åœ¨rebalanceæ—¶ä¸å…è®¸ä¸‹å‘é‡è¯•æµé‡è¿‡æ»¤ç­–ç•¥
2. (åœæ­¢ç­–ç•¥)StopStrategies
   - ResultStatusStopStrategy: è°ƒç”¨å®¢æˆ·ç«¯å‘ç”Ÿå¼‚å¸¸è§¦å‘åœæ­¢ç­–ç•¥
   - ResultStatusCodeStopStrategy: æ ¹æ®å®¢æˆ·ç«¯è¿”å›çŠ¶æ€åˆ¤æ–­æ˜¯å¦ç»ˆæ­¢é‡è¯•
   - ExceptionStopStrategy: æ ¹æ®å®¢æˆ·ç«¯è¿”å›ç»“æœå¯¹è±¡çš„çŠ¶æ€ç åˆ¤æ–­æ˜¯å¦ç»ˆæ­¢é‡è¯•
3. (ç­‰å¾…ç­–ç•¥)WaitStrategies
  - DelayLevelWaitStrategy: å»¶è¿Ÿç­‰çº§ç­‰å¾…ç­–ç•¥
  - FixedWaitStrategy: å›ºå®šå®šæ—¶é—´ç­‰å¾…ç­–ç•¥
  - CronWaitStrategy: cronç­‰å¾…ç­–ç•¥
  - RandomWaitStrategy: éšæœºç­‰å¾…ç­–ç•¥

### ğŸŸ¢æ‰§è¡Œç»“æœå¤„ç†å™¨
ä»»åŠ¡è°ƒåº¦æˆåŠŸ(FinishActor)
`FinishActor`ç›‘å¬ä»»åŠ¡å®Œæˆæ¶ˆæ¯ï¼Œ
- è‹¥æ˜¯é‡è¯•ä»»åŠ¡å®Œæˆéœ€è¦åˆ›å»ºä¸€ä¸ªå›è°ƒä»»åŠ¡ï¼Œæ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå·²å®Œæˆ
- è‹¥æ˜¯å›è°ƒä»»åŠ¡ç›´æ¥æ›´æ–°ä»»åŠ¡ä¸ºå·²å®Œæˆ

ä»»åŠ¡è°ƒåº¦å¤±è´¥(FailureActor)
`FailureActor`ç›‘å¬ä»»åŠ¡æ‰§è¡Œå¤±è´¥æ¶ˆæ¯
- è‹¥æ˜¯é‡è¯•ä»»åŠ¡åˆ°è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œåˆ™æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºæœ€å¤§æ¬¡æ•°å¹¶åˆ›å»ºä¸€ä¸ªå›è°ƒä»»åŠ¡
- è‹¥æ˜¯å›è°ƒä»»åŠ¡åˆ°è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œåˆ™æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºæœ€å¤§æ¬¡æ•°

## ğŸ”´å…¶ä»–æ¨¡å—
### ğŸŸ¢ç»„è´Ÿè½½å‡è¡¡å™¨
ç»„è´Ÿè½½å‡è¡¡å™¨é€šè¿‡ä¸€è‡´æ€§HASHç®—æ³•å°†ç»„å‡åŒ€çš„åˆ†é…åˆ°æ¯ä¸ªæœåŠ¡ç«¯èŠ‚ç‚¹ä¸Š
ä»¥ä¸‹æ˜¯è§¦å‘ç»„è´Ÿè½½å‡è¡¡å™¨ReBalanceçš„æ¡ä»¶
- è‹¥æœ¬åœ°ç¼“å­˜èŠ‚ç‚¹ä¸ºç©ºåˆ™è§¦å‘ReBalance
- è‹¥è¿œç¨‹çš„èŠ‚ç‚¹ä¸æœ¬åœ°ç¼“å­˜èŠ‚ç‚¹æ•°é‡ä¸ä¸€è‡´åˆ™è§¦å‘ReBalance
- è‹¥è¿œç¨‹çš„èŠ‚ç‚¹ä¸æœ¬åœ°ç¼“å­˜èŠ‚ç‚¹hostIdä¸åŒ¹é…åˆ™è§¦å‘ReBalance
- è‹¥ç»„è¿œç¨‹çš„ç»„æ•°é‡ä¸æœ¬åœ°ç¼“å­˜çš„ç»„æ•°é‡ä¸ä¸€è‡´åˆ™è§¦å‘è§¦å‘ReBalance

### ğŸŸ¢é…ç½®ä¸­å¿ƒ
- é…ç½®ç®¡ç†
  é€šè¿‡æ§åˆ¶å°è¿›è¡Œç»„ã€åœºæ™¯ã€é€šçŸ¥é…ç½®
- é…ç½®é€šçŸ¥
  - æœåŠ¡ç«¯ä¸»åŠ¨æ„ŸçŸ¥ç‰ˆæœ¬å˜æ›´: æ§åˆ¶å°å˜æ›´é…ç½®æ—¶ç‰ˆæœ¬å·ä¼šè‡ªå¢ï¼Œæ­¤æ¬¡ä¼šé€šçŸ¥å®¢æˆ·ç«¯é…ç½®å˜æ›´
  - å®¢æˆ·ç«¯æºå¸¦ç‰ˆæœ¬å·: å®¢æˆ·ç«¯æ¯æ¬¡è¯·æ±‚æœåŠ¡ç«¯éƒ½ä¼šæºå¸¦ç‰ˆæœ¬å·ä¸æœåŠ¡ç«¯æ ¡éªŒç‰ˆæœ¬æ˜¯å¦ä¸€è‡´
  å½“ç‰ˆæœ¬å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä»¥è½®è¯¢æ–¹å¼é€šçŸ¥å®¢æˆ·ç«¯å˜æ›´é…ç½®

### ğŸŸ¢æ³¨å†Œä¸­å¿ƒ
#### æ³¨å†Œ
  - å®¢æˆ·ç«¯ä½¿ç”¨Nettyçš„å¿ƒè·³(30sä¸€æ¬¡)ä¸æœåŠ¡ç«¯ä¿æŒè¿æ¥ï¼Œæ¯æ¬¡å¿ƒè·³éƒ½ä¼šå°†ä»»åŠ¡æ”¾åˆ°æœ¬åœ°é˜Ÿåˆ—ä¸­æœ‰å®šæ—¶ä»»åŠ¡è·å–é˜Ÿåˆ—ä¿¡æ¯æ›´æ–°è¿‡æœŸæ—¶é—´
  - æœåŠ¡ç«¯ä½¿ç”¨å®šæ—¶(30sä¸€æ¬¡)ä»»åŠ¡å®šæ—¶æ›´æ–°è¿‡æœŸæ—¶é—´
#### è¿‡æœŸä¸‹çº¿
  - åˆ é™¤åˆ°è¾¾è¿‡æœŸæ—¶é—´çš„èŠ‚ç‚¹
### ğŸŸ¢å…¨å±€idç”Ÿæˆå™¨
å·æ®µæ¨¡å¼: å·æ®µæ¨¡å¼ä½¿ç”¨è‡ªç¾å›¢çš„leafå·æ®µæ¨¡å¼
é›ªèŠ±ç®—æ³•: ä½¿ç”¨hutoolè‡ªå¸¦çš„é›ªèŠ±ç®—æ³•ç”Ÿæˆidï¼Œè‹¥å‡ºç°æ—¶é—´å›æ‹¨é—®é¢˜åˆ™ç›´æ¥æŠ¥é”™
### ğŸŸ¢æ—¥å¿—æ¨¡å—
æ—¥å¿—åˆ†ä¸º`retry_task_log`å’Œ`retry_task_log_message`è¡¨
- `retry_task_log`è¡¨ä¸»è¦æ˜¯å­˜æ”¾ä»»åŠ¡çš„ä¸»è¦ä¿¡æ¯åŒ…æ‹¬ unique_idã€group_nameã€scene_nameã€idempotent_idã€retry_statusç­‰
- `retry_task_log_message`è¡¨å­˜æ”¾æ¯æ¬¡è°ƒåº¦äº§ç”Ÿçš„ç»“æœä¿¡æ¯
### ğŸŸ¢å‘Šè­¦é€šçŸ¥
> ç›®å‰å·²æ”¯æŒé’‰é’‰é€šçŸ¥ã€é‚®ç®±é€šçŸ¥ã€é£ä¹¦é€šçŸ¥
- é€šçŸ¥åœºæ™¯:
    - é‡è¯•æ•°é‡è¶…è¿‡é˜ˆå€¼: ä½œç”¨äºæœåŠ¡ç«¯ï¼Œé‡è¯•ä¸­çš„æ•°é‡åˆ°è¾¾é˜ˆå€¼å‘é€é€šçŸ¥
    - é‡è¯•å¤±è´¥æ•°é‡è¶…è¿‡é˜ˆå€¼: ä½œç”¨äºæœåŠ¡ç«¯ï¼Œè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°çš„æ•°é‡åˆ°è¾¾é˜ˆå€¼å‘é€é€šçŸ¥
    - å®¢æˆ·ç«¯ä¸ŠæŠ¥å¤±è´¥: ä½œç”¨äºå®¢æˆ·ç«¯ï¼Œä¸ŠæŠ¥æ•°æ®å¤±è´¥ å‘é€ é€šçŸ¥
## ğŸ”´é€šä¿¡æ¨¡å—
### RpcClint
> RpcClintæ˜¯é€šè¿‡åŠ¨æ€ä»£ç†å®ç°çš„å¯ä»¥åŸºäºé…ç½®çš„è·¯ç”±ç­–ç•¥é€‰å–å¯æ‰§è¡Œçš„å®¢æˆ·ç«¯IP+PORT, å¹¶æ”¯æŒè·¯ç”±å‰”é™¤å’Œè·¯ç”±è½¬ç§»åŠŸèƒ½

#### å®¢æˆ·ç«¯è·¯ç”±ç­–ç•¥ç®—æ³•
  - ä¸€è‡´æ€§Hashç®—æ³•
  - LRUç®—æ³•
  - éšæœºç®—æ³•

#### è·¯ç”±å‰”é™¤
  å½“è°ƒç”¨å®¢æˆ·ç«¯æ—¶å‡ºç°ç½‘ç»œå¼‚å¸¸æ—¶ï¼Œè‡ªåŠ¨å‰”é™¤å½“å‰æ´»è·ƒåˆ—è¡¨ä¸­çš„è·¯ç”±ä¿¡æ¯(IP+PORT)
#### è·¯ç”±è½¬ç§»
  é‡æ–°åœ¨æ´»è·ƒåˆ—è¡¨ä¸­é€‰å–ä¸€ä¸ªè·¯ç”±ä¿¡æ¯ï¼Œè°ƒç”¨å®¢æˆ·ç«¯

### NettyServer
> å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚

- BeatHttpRequestHandler(/beat)
  æ¥æ”¶å¿ƒè·³è¯·æ±‚ï¼Œå­˜å‚¨åˆ°æœ¬åœ°é˜Ÿåˆ—
- ConfigHttpRequestHandler(/config)
  è·å–æœ€æ–°çš„é…ç½®ä¿¡æ¯
- ReportRetryInfoHttpRequestHandler(/batch/report)
  æ¥å—å¹¶å¤„ç†ä¸ŠæŠ¥çš„ä¿¡æ¯